@using ProjectManager.Backend.DTOs.Projects
@model IEnumerable<ProjectDto>

@{
    ViewData["Title"] = "Список проектов";
    string startFrom = ViewData["startFrom"] as string ?? "";
    string startTo = ViewData["startTo"] as string ?? "";
    string minPriority = ViewData["minPriority"] as string ?? "";
    string maxPriority = ViewData["maxPriority"] as string ?? "";
    string search = ViewData["search"] as string ?? "";
    string sortBy = ViewData["sortBy"] as string ?? "StartDate";
    string sortDir = ViewData["sortDir"] as string ?? "asc";

    Func<string, string> toggleDir = (col) => {
        if (col == sortBy) return sortDir == "asc" ? "desc" : "asc";
        return "asc";
    };
}

<h2>Список проектов</h2>

<div class="row">
    <div class="col-3">
        <form method="get" class="d-flex flex-column gap-2">

            <input type="date" name="startFrom"
                   value="@startFrom" class="form-control" placeholder="С даты" />

            <input type="date" name="startTo"
                   value="@startTo" class="form-control" placeholder="По дату" />

            <input type="number" min="1" max="100" name="minPriority"
                   value="@minPriority" class="form-control" placeholder="Мин приоритет" />

            <input type="number" min="1" max="100" name="maxPriority"
                   value="@maxPriority" class="form-control" placeholder="Макс приоритет" />

            <input type="text" name="search"
                   value="@search" class="form-control"
                   placeholder="Поиск по названию/заказчику/исполнителю" />

            <select name="sortBy" class="form-select">
                <option value="StartDate" selected="@(sortBy=="StartDate")">Дата начала</option>
                <option value="EndDate" selected="@(sortBy=="EndDate")">Дата окончания</option>
                <option value="Priority" selected="@(sortBy=="Priority")">Приоритет</option>
                <option value="Title" selected="@(sortBy=="Title")">Название</option>
                <option value="Customer" selected="@(sortBy=="Customer")">Заказчик</option>
            </select>

            <select name="sortDir" class="form-select">
                <option value="asc" selected="@(sortDir=="asc")">По возр.</option>
                <option value="desc" selected="@(sortDir=="desc")">По убыв.</option>
            </select>

            <button class="btn btn-primary mt-2">Применить</button>
            <a class="btn btn-secondary" href="/Projects">Сброс</a>
        </form>

        <a class="btn btn-success mt-3 w-100" href="/ProjectWizard/Step1">
            Создать проект
        </a>
    </div>

    <div class="col-9">
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th><a href="?@($"sortBy=Title&sortDir={toggleDir("Title")}")">Название</a></th>
                    <th><a href="?@($"sortBy=Customer&sortDir={toggleDir("Customer")}")">Заказчик</a></th>
                    <th><a href="?@($"sortBy=Contractor&sortDir={toggleDir("Contractor")}")">Исполнитель</a></th>
                    <th><a href="?@($"sortBy=StartDate&sortDir={toggleDir("StartDate")}")">Дата начала</a></th>
                    <th>Приоритет</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var p in Model)
            {
                <tr>
                    <td>@p.Id</td>
                    <td>@p.Title</td>
                    <td>@p.CustomerCompany</td>
                    <td>@p.ContractorCompany</td>
                    <td>@p.StartDate.ToShortDateString()</td>
                    <td>@p.Priority</td>
                    <td>
                        <a class="btn btn-sm btn-info" href="/Projects/Details/@p.Id">Открыть</a>
                        <a class="btn btn-sm btn-warning ms-1" href="/Projects/Edit/@p.Id">Редактировать</a>

                        <form asp-action="Delete"
                              asp-route-id="@p.Id"
                              method="post"
                              style="display:inline;">
                            @Html.AntiForgeryToken()
                            <button type="submit"
                                    class="btn btn-sm btn-danger ms-1"
                                    onclick="return confirm('Удалить проект ID=@p.Id?');">
                                Удалить
                            </button>
                        </form>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
</div>
